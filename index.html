<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Mappa Esagoni - Tabellone</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f0f2f5;
      --text: #222;
      --stroke: #333;
      --shadow: 2px 2px 6px rgba(0,0,0,0.35);
    }
    .dark {
      --bg: #121212;
      --text: #eee;
      --stroke: #ddd;
      --shadow: 2px 2px 8px rgba(0,0,0,0.6);
    }

    body {
      margin:0; background:var(--bg); color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      display:flex; flex-direction:column; gap:10px; align-items:center;
      min-height:100vh;
    }

    .toolbar {
      display:flex; gap:8px; align-items:center; justify-content:center;
      padding:10px 12px;
      position:sticky; top:0; z-index:10;
      backdrop-filter:saturate(1.2) blur(6px);
    }

    button {
      border:0; border-radius:10px; padding:10px 14px; font-size:16px;
      box-shadow: var(--shadow); background:#1e88e5; color:#fff; cursor:pointer;
    }
    button.secondary { background:#6c757d; }
    button:hover { filter:brightness(0.95); }

    #canvas {
      width: 95vw; height: 86vh; max-width: 1100px; max-height: 1100px;
      background: transparent;
    }

    polygon {
      stroke: var(--stroke);
      stroke-width: 2;
      opacity: 0;
      transform: scale(0.85);
      transition: transform .45s ease, opacity .45s ease;
    }
    polygon.appear { opacity:1; transform: scale(1); }

    text {
      font-size: 26px; font-weight: 800;
      text-anchor: middle; dominant-baseline: middle;
      paint-order: stroke; stroke: rgba(0,0,0,0.85); stroke-width: 3px;
      stroke-linejoin: round; fill: #fff; pointer-events:none;
    }
    .big-label { font-size: 34px; }
    .huge-label { font-size: 48px; }

    .outerHex {
      fill: white;
      stroke: black;
      stroke-width: 6;
      filter: drop-shadow(0 4px 10px rgba(0,0,0,0.6));
    }

    #note { font:14px/1.4 system-ui, sans-serif; opacity:0.85; margin-bottom:8px; text-align:center; }
  </style>
</head>
<body>
  <div class="toolbar">
    <button id="regen">ðŸ”„ Rigenera Tabellone</button>
    <button id="toggle" class="secondary">ðŸŒ“ Light/Dark</button>
  </div>

  <svg id="canvas" viewBox="0 0 1600 1600" preserveAspectRatio="xMidYMid meet"></svg>
  <div id="note"></div>

  <script>
    const svg = document.getElementById("canvas");
    const note = document.getElementById("note");
    const btnRegen = document.getElementById("regen");
    const btnToggle = document.getElementById("toggle");

    // === Dimensione base degli esagoni (ingrandita del 33%) ===
    const size = 128;
    const internalColors = ["green","yellow","red","purple","blue","grey"];

    const hexCoords = [
      [0,0], 
      [1,0],[1,-1],[0,-1],[-1,0],[-1,1],[0,1], 
      [2,0],[2,-1],[2,-2],[1,-2],[0,-2],[-1,-1],
      [-2,0],[-2,1],[-2,2],[-1,2],[0,2],[1,1]
    ];

    const outerHexCoords = [[1,-3],[3,-1],[-1,3],[-3,1]];

    function axialToPixel(q,r,s){ return [ s*Math.sqrt(3)*(q + r/2), s*1.5*r ]; }
    function hexPoints(cx, cy, r){
      const pts=[]; for(let i=0;i<6;i++){ const a=Math.PI/3*i + Math.PI/6; pts.push(`${cx+r*Math.cos(a)},${cy+r*Math.sin(a)}`); }
      return pts.join(" ");
    }
    function hexDist(q1,r1,q2,r2){
      return (Math.abs(q1-q2)+Math.abs(r1-r2)+Math.abs((-q1-r1)-(-q2-r2)))/2;
    }
    function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }

    function generatePalette(){
      const pal=["black"];
      const first=shuffle([...internalColors]);
      pal.push(...first);
      const rest=[]; internalColors.forEach(c=>rest.push(c,c));
      pal.push(...shuffle(rest));
      return pal;
    }
    function buildColorMap(pal){ const m=new Map(); hexCoords.forEach(([q,r],i)=>m.set(`${q},${r}`, pal[i])); return m; }

    function validFrom(colorMap, Q, R){
      const seen = new Set();
      for(const [hq,hr] of hexCoords){
        if (hexDist(Q,R,hq,hr) <= 2){
          const c = colorMap.get(`${hq},${hr}`);
          if (seen.has(c)) return false;
          seen.add(c);
        }
      }
      return true;
    }

    function drawHexes(){
      svg.innerHTML=""; note.textContent="";
      const g = document.createElementNS("http://www.w3.org/2000/svg","g");
      g.setAttribute("transform","translate(800,800) rotate(-45)");
      svg.appendChild(g);

      const labels = shuffle(["A","B","C","D"]);
      const starts = {}; labels.forEach((lab,i)=>{ starts[lab]=outerHexCoords[i]; });

      let attempts=0, ok=false, palette, cmap;
      const MAX=400000;
      while(attempts<MAX){
        attempts++;
        palette = generatePalette();
        cmap = buildColorMap(palette);
        if (labels.every(lab => { const [Q,R]=starts[lab]; return validFrom(cmap,Q,R); })){
          ok=true; break;
        }
      }
      note.textContent = ok
        ? `âœ… Configurazione valida dopo ${attempts} tentativi.`
        : `âš ï¸ Nessuna configurazione valida entro ${MAX} tentativi.`;

      let thronePlaced=false;
      hexCoords.forEach(([q,r],i)=>{
        const [x,y]=axialToPixel(q,r,size);
        const color = palette[i];

        const poly=document.createElementNS("http://www.w3.org/2000/svg","polygon");
        poly.setAttribute("points", hexPoints(x,y,size));
        poly.setAttribute("fill", color);
        g.appendChild(poly);
        setTimeout(()=>poly.classList.add("appear"), i*35);

        if (q===0 && r===0){
          const t=document.createElementNS("http://www.w3.org/2000/svg","text");
          t.setAttribute("x",x); t.setAttribute("y",y);
          t.setAttribute("class","big-label");
          t.textContent="Rosa Nera";
          g.appendChild(t);
        }
        if (!thronePlaced && Math.abs(q)+Math.abs(r)===1 && (color==="purple" || color==="violet")){
          thronePlaced=true;
          const t=document.createElementNS("http://www.w3.org/2000/svg","text");
          t.setAttribute("x",x); t.setAttribute("y",y);
          t.setAttribute("class","big-label");
          t.textContent="Sala Trono";
          g.appendChild(t);
        }
      });

      outerHexCoords.forEach(([q,r],i)=>{
        const [x,y]=axialToPixel(q,r,size);
        const label = labels[i];

        const p=document.createElementNS("http://www.w3.org/2000/svg","polygon");
        p.setAttribute("points", hexPoints(x,y,size));
        p.setAttribute("class","outerHex");
        g.appendChild(p);
        setTimeout(()=>p.classList.add("appear"), 800 + i*200);

        const t=document.createElementNS("http://www.w3.org/2000/svg","text");
        t.setAttribute("x",x); t.setAttribute("y",y);
        t.setAttribute("class","huge-label");
        t.textContent = label;
        g.appendChild(t);
      });
    }

    btnRegen.addEventListener("click", drawHexes);
    btnToggle.addEventListener("click", ()=>{ document.body.classList.toggle("dark"); });

    drawHexes();
  </script>
</body>
</html>
